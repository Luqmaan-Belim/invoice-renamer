name: drive_change

on:
  repository_dispatch:
    types: [drive_change]
  workflow_dispatch: {}

# Ensure only one run does work at a time; new dispatches wait for earlier runs.
concurrency:
  group: invoice-renamer-drive-change
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for earlier drive_change runs to finish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_FILE: invoice-renamer.yml
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          echo "Checking for earlier workflow runs before continuing..."
          attempts=0
          while true; do
            older=$(gh api repos/${GITHUB_REPOSITORY}/actions/workflows/${WORKFLOW_FILE}/runs \
              -F per_page=100 \
              --jq '.workflow_runs[] | select((.status=="in_progress" or .status=="queued" or .status=="waiting") and .run_number < ($env.RUN_NUMBER|tonumber)) | .id' \
              | head -n1)
            if [ -z "$older" ]; then
              echo "No earlier runs are active; continuing."
              break
            fi
            attempts=$((attempts + 1))
            if [ "$attempts" -ge 40 ]; then
              echo "Timed out waiting for earlier runs after $attempts checks." >&2
              exit 1
            fi
            echo "Earlier run $older still active. Waiting 30s before rechecking..."
            sleep 30
          done

      # --- Restore the last startPageToken so we only process NEW changes
      - name: Restore Drive change token
        id: token-restore
        uses: actions/cache/restore@v4
        with:
          path: .drive_change_token
          # we save with a unique key each run; restore picks the most recent by prefix
          key: drive-token-
          restore-keys: |
            drive-token-

      # (optional) show whether we actually restored a token
      - name: Show restored token (optional)
        run: |
          if [[ -f .drive_change_token ]]; then
            echo "Restored token file:"
            cat .drive_change_token
          else
            echo "No token restored; first run will initialize a token."
          fi

      # --- System deps (tesseract for pytesseract)
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr

      # --- Python deps
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python requirements
        run: |
          pip install --upgrade pip
          pip install google-api-python-client google-auth \
                      PyMuPDF pillow numpy opencv-python-headless pytesseract

      # --- Run the changes-only processor
      - name: Process IMG*.pdf files (changes-only)
        env:
          GDRIVE_SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          DEBUG_LIST: ${{ vars.DEBUG_LIST }}
        run: |
          python process_invoices.py

      # --- Save updated token so next run uses deltas, not init
      - name: Save Drive change token
        # always try to save (even if the job was canceled)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .drive_change_token
          # unique key so it can be updated; restore uses the 'drive-token-' prefix
          key: drive-token-${{ github.run_id }}
